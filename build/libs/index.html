<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>CheerpJ test</title>
    <script src="https://cjrtnc.leaningtech.com/2.3/loader.js"></script>
  </head>
  <body>
  </body>
  <script>
    var w = window.innerWidth-20;
    var h = window.innerHeight-20;
      cheerpjInit({javaProperties:["java.protocol.handler.pkgs=com.leaningtech.handlers"],clipboardMode:"system"});
      cheerpjCreateDisplay(w,h);
      cheerpjRunJar("/app/Dominion-1.0-SNAPSHOT-all.jar");
  </script>

  <script src="https://cdn.jsdelivr.net/npm/ipfs/dist/index.min.js"></script>
  <script type="text/javascript">
    document.addEventListener('DOMContentLoaded', async () => {
      const ipfs = await Ipfs.create({
        repo: 'ipfs-' + Math.random(),
      })
      window.node = ipfs

      const status = ipfs.isOnline() ? 'online' : 'offline'

      uploadIPFS("SGVsbG8gV29ybGQ=");
      console.log(downloadIPFS("QmUXTtySmd7LD4p6RG6rZW6RuUuPZXTtNMmRQ6DSQo3aMw"));
      function downloadIPFS(cid){
        var encoder = new TextEncoder("ascii");
        var decoder = new TextDecoder("ascii");
        var base64Table = encoder.encode('ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=');

        function toBase64(dataArr){
          var padding = dataArr.byteLength % 3;
          var len = dataArr.byteLength - padding;
          padding = padding > 0 ? (3 - padding) : 0;
          var outputLen = ((len/3) * 4) + (padding > 0 ? 4 : 0);
          var output = new Uint8Array(outputLen);
          var outputCtr = 0;
          for(var i=0; i<len; i+=3){
            var buffer = ((dataArr[i] & 0xFF) << 16) | ((dataArr[i+1] & 0xFF) << 8) | (dataArr[i+2] & 0xFF);
            output[outputCtr++] = base64Table[buffer >> 18];
            output[outputCtr++] = base64Table[(buffer >> 12) & 0x3F];
            output[outputCtr++] = base64Table[(buffer >> 6) & 0x3F];
            output[outputCtr++] = base64Table[buffer & 0x3F];
          }
          if (padding == 1) {
            var buffer = ((dataArr[len] & 0xFF) << 8) | (dataArr[len+1] & 0xFF);
            output[outputCtr++] = base64Table[buffer >> 10];
            output[outputCtr++] = base64Table[(buffer >> 4) & 0x3F];
            output[outputCtr++] = base64Table[(buffer << 2) & 0x3F];
            output[outputCtr++] = base64Table[64];
          } else if (padding == 2) {
            var buffer = dataArr[len] & 0xFF;
            output[outputCtr++] = base64Table[buffer >> 2];
            output[outputCtr++] = base64Table[(buffer << 4) & 0x3F];
            output[outputCtr++] = base64Table[64];
            output[outputCtr++] = base64Table[64];
          }

          var ret = decoder.decode(output);
          output = null;
          dataArr = null;
          return ret;
        }
        function ggg(cid,cat,chunks){
          cat.next().then(function(chunk){
            if (chunk.done){
              const bytesString = String.fromCharCode(...chunks)
              console.log(chunks);
              console.log("/str/"+cid+"\t"+bytesString);
              delete chunks;
              cheerpjAddStringFile("/str/"+cid, toBase64(chunks));
              // self.@com.klemstinegroup.sunshineblue.client.NativeGWT::finishDownload(Ljava/lang/String;I)(toBase64(chunks),iii);
            }
            else{
              var chunv=chunk.value;
              var c=new Uint8Array(chunks.length +chunv.length);
              c.set(chunks);
              c.set(chunv,chunks.length);
              setTimeout(function(){ggg(cid,cat,c);},200);
            }

          });
        }

        function run(cid1){
          console.log("loading1 cid:"+cid1);
          if(!(window.node&& window.node.isOnline())){
            console.log("Node not running!");
            setTimeout(function(){run(cid1);},1000);
          }

          else{
            window.node.pin.add(cid1).then();
            ggg(cid1,window.node.cat(cid1),new Uint8Array());
          }
        };
        run(cid);
      }
      function uploadIPFS(base64) {
        var byteCharacters = atob(base64);
        var byteNumbers = new Array(byteCharacters.length);
        for (var i = 0; i < byteCharacters.length; i++) {
          byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        var byteArray = new Uint8Array(byteNumbers);
        if (!(window.node && window.node.isOnline())) {
          console.log("Node not running!");
        } else {
          window.node.add(byteArray).then(function (fileAdded) {
            console.log('Added file:', fileAdded.path);
            window.node.pin.add(fileAdded.path).then();
          });
        }
      };console.log(`Node status: ${status}`)
    })
  </script>
</html>